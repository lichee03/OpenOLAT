#set($locale = "en")
<div id="selective-template-instantiate">
	<div class="row">
		<div class="col-md-6">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">$translator.translate('select.course.elements')</h3>
				</div>
				<div class="panel-body">
					<div id="elements-container">
						#if($templateElements && $templateElements.size() > 0)
							<div class="list-group">
								#foreach($element in $templateElements)
									<div class="list-group-item" style="padding-left: #evaluate($element.level * 20)px">
										<div class="checkbox">
											<label>
												<input type="checkbox" name="element_$element.nodeId" 
													   value="$element.nodeId" class="element-checkbox">
												<strong>$element.title</strong>
												#if($element.description)
													<br><small class="text-muted">$element.description</small>
												#end
												<br><small class="text-info">[$element.nodeType]</small>
											</label>
										</div>
									</div>
								#end
							</div>
						#else
							<p class="text-muted">$translator.translate('no.elements.available')</p>
						#end
					</div>
				</div>
			</div>
		</div>
		
		<div class="col-md-6">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">$translator.translate('select.resources')</h3>
				</div>
				<div class="panel-body">
					<div id="resources-container">
						#if($templateResources && $templateResources.size() > 0)
							<div class="list-group">
								#foreach($resource in $templateResources)
									<div class="list-group-item">
										<div class="checkbox">
											<label>
												<input type="checkbox" name="resource_$resource.resourceId" 
													   value="$resource.resourceId" class="resource-checkbox">
												<strong>$resource.name</strong>
												#if($resource.size > 0)
													<br><small class="text-muted">$translator.translate('size'): #evaluate($resource.size / 1024 / 1024) MB</small>
												#end
												#if($resource.linkedNodeId)
													<br><small class="text-info">$translator.translate('linked.to'): $resource.linkedNodeId</small>
												#end
											</label>
										</div>
									</div>
								#end
							</div>
						#else
							<p class="text-muted">$translator.translate('no.resources.available')</p>
						#end
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="row" style="margin-top: 20px;">
		<div class="col-md-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">$translator.translate('copy.options')</h3>
				</div>
				<div class="panel-body">
					<div class="form-group">
						<div class="checkbox">
							<label>
								<input type="checkbox" id="deep-copy-toggle" name="deep_copy" value="true">
								$translator.translate('deep.copy.resources')
								<small class="text-muted">$translator.translate('deep.copy.help')</small>
							</label>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	#if($preview)
		<div class="row" style="margin-top: 20px;">
			<div class="col-md-12">
				<div class="panel panel-info">
					<div class="panel-heading">
						<h3 class="panel-title">$translator.translate('selection.preview')</h3>
					</div>
					<div class="panel-body">
						<p>
							$translator.translate('elements.selected'): <strong>$preview.totalElementsSelected</strong>
						</p>
						<p>
							$translator.translate('resources.selected'): <strong>$preview.totalResourcesSelected</strong>
						</p>
						<p>
							$translator.translate('estimated.size'): <strong>#evaluate($preview.estimatedSize / 1024 / 1024) MB</strong>
						</p>
						
						#if($preview.warnings && $preview.warnings.size() > 0)
							<div class="alert alert-warning">
								<strong>$translator.translate('warnings')</strong>
								<ul>
									#foreach($warning in $preview.warnings)
										<li>$warning</li>
									#end
								</ul>
							</div>
						#end
						
						#if($preview.dependencies && $preview.dependencies.size() > 0)
							<div class="alert alert-info">
								<strong>$translator.translate('dependencies')</strong>
								<ul>
									#foreach($dep in $preview.dependencies)
										<li>$dep</li>
									#end
								</ul>
							</div>
						#end
					</div>
				</div>
			</div>
		</div>
	#end
	
	<div class="row" style="margin-top: 20px;">
		<div class="col-md-12">
			<button type="button" id="back-button" class="btn btn-default">
				$translator.translate('back')
			</button>
			<button type="button" id="continue-button" class="btn btn-primary pull-right">
				$translator.translate('continue')
			</button>
		</div>
	</div>
</div>

<script type="text/javascript">
jQuery(function() {
	// Element selection handling
	jQuery('.element-checkbox').on('change', function() {
		var elementId = jQuery(this).val();
		var isChecked = jQuery(this).is(':checked');
		
		if (isChecked) {
			// Auto-include parent if child is selected
			var parentElement = jQuery(this).closest('.list-group-item').prev('.list-group-item');
			if (parentElement.length > 0) {
				parentElement.find('input[type="checkbox"]').prop('checked', true);
			}
		}
	});
	
	// Resource selection handling
	jQuery('.resource-checkbox').on('change', function() {
		updatePreview();
	});
	
	// Deep copy toggle
	jQuery('#deep-copy-toggle').on('change', function() {
		updatePreview();
	});
	
	// Back button
	jQuery('#back-button').on('click', function() {
		// Fire back event
		window.location.href = jQuery(this).data('back-url');
	});
	
	// Continue button
	jQuery('#continue-button').on('click', function() {
		// Collect selections and submit
		var selectedElements = [];
		jQuery('.element-checkbox:checked').each(function() {
			selectedElements.push(jQuery(this).val());
		});
		
		var selectedResources = [];
		jQuery('.resource-checkbox:checked').each(function() {
			selectedResources.push(jQuery(this).val());
		});
		
		// Store and proceed
		console.log('Selected elements:', selectedElements);
		console.log('Selected resources:', selectedResources);
	});
});

function updatePreview() {
	// AJAX call to update preview
	var selectedElements = jQuery('.element-checkbox:checked').map(function() {
		return jQuery(this).val();
	}).get();
	
	var selectedResources = jQuery('.resource-checkbox:checked').map(function() {
		return jQuery(this).val();
	}).get();
	
	console.log('Updating preview with', selectedElements.length, 'elements and', 
		selectedResources.length, 'resources');
}
</script>

<style>
#selective-template-instantiate .list-group-item {
	border-left: 3px solid #ddd;
	margin-bottom: 5px;
}

#selective-template-instantiate .list-group-item:hover {
	background-color: #f5f5f5;
}

#selective-template-instantiate .checkbox {
	margin: 0;
}

#selective-template-instantiate .checkbox label {
	display: block;
	padding: 5px 0;
	margin: 0;
	font-weight: normal;
}

#selective-template-instantiate .text-info {
	color: #5bc0de;
}
</style>
